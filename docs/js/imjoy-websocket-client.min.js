!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("imjoyWebsocketClient",[],t):"object"==typeof exports?exports.imjoyWebsocketClient=t():e.imjoyWebsocketClient=t()}(window,(function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(module,__webpack_exports__,__webpack_require__){"use strict";function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}__webpack_require__.d(__webpack_exports__,"e",(function(){return randId})),__webpack_require__.d(__webpack_exports__,"c",(function(){return dtypeToTypedArray})),__webpack_require__.d(__webpack_exports__,"d",(function(){return loadRequirements})),__webpack_require__.d(__webpack_exports__,"f",(function(){return typedArrayToDtype})),__webpack_require__.d(__webpack_exports__,"b",(function(){return assert})),__webpack_require__.d(__webpack_exports__,"a",(function(){return MessageEmitter}));const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise((t,r)=>{var i=document.createElement("script");i.src=e,i.type="text/javascript",i.onload=t,i.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},i.onerror=r,document.head.appendChild(i)})}async function r(){for(var e=Array.prototype.slice.call(arguments),r=e.length,i=0;i<r;i++)await t(e[i])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var i;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var n=0;n<e.length;n++)e[n].toLowerCase().endsWith(".css")||e[n].startsWith("css:")?(e[n].startsWith("css:")&&(e[n]=e[n].slice(4)),(i=document.createElement("link")).rel="stylesheet",i.href=e[n],document.head.appendChild(i)):e[n].toLowerCase().endsWith(".mjs")||e[n].startsWith("mjs:")?(e[n].startsWith("mjs:")&&(e[n]=e[n].slice(4)),await import(e[n])):e[n].toLowerCase().endsWith(".js")||e[n].startsWith("js:")?(e[n].startsWith("js:")&&(e[n]=e[n].slice(3)),await r(e[n])):e[n].startsWith("http")?await r(e[n]):e[n].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[n])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce((t,r)=>("function"!=typeof e[r]&&(t[r]=e[r]),t),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const r=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(r instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,r){const i={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void r("Service worker is not supported.");const n=new MessageChannel;n.port1.onmessage=function(e){e.data&&e.data.error?r(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(i,[n.port2]):r("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch(e=>{console.error(e)})}function setupServiceWorker(e,t,r){if("serviceWorker"in navigator){if(e=e||"/",navigator.serviceWorker.register(e+"plugin-service-worker.js").then((function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}),(function(e){console.log("ServiceWorker registration failed: ",e)})),t=t||"*",(r=r||cacheRequirements)&&"function"!=typeof r)throw new Error("config.cache_requirements must be a function");window.addEventListener("message",(function(e){if("*"===t||e.origin===t){const t=e.data;"cacheRequirements"===t.type&&r(t.requirements)}}))}}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const r=this._event_handlers[e].indexOf(t);r>=0&&this._event_handlers[e].splice(r,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var r=this._event_handlers[e].length;r--;){const i=this._event_handlers[e][r];try{i(t)}catch(e){console.error(e)}finally{i.___event_run_once&&this._event_handlers[e].splice(r,1)}}else this._debug&&console.warn("unhandled event",e,t)}}},function(e,t,r){"use strict";r.r(t);var i=r(0);function n(e){return(e<0?"-":"")+"0x"+Math.abs(e).toString(16).padStart(2,"0")}var o,s=function(e,t){this.type=e,this.data=t},a=(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),c=function(e){function t(r){var i=e.call(this,r)||this,n=Object.create(t.prototype);return Object.setPrototypeOf(i,n),Object.defineProperty(i,"name",{configurable:!0,enumerable:!1,value:t.name}),i}return a(t,e),t}(Error),h=4294967295;function l(e,t,r){var i=Math.floor(r/4294967296),n=r;e.setUint32(t,i),e.setUint32(t+4,n)}function f(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}var u=4294967295,d=17179869183;var _={type:-1,encode:function(e){var t,r,i,n;return e instanceof Date?function(e){var t,r=e.sec,i=e.nsec;if(r>=0&&i>=0&&r<=d){if(0===i&&r<=u){var n=new Uint8Array(4);return(t=new DataView(n.buffer)).setUint32(0,r),n}var o=r/4294967296,s=4294967295&r;n=new Uint8Array(8);return(t=new DataView(n.buffer)).setUint32(0,i<<2|3&o),t.setUint32(4,s),n}return n=new Uint8Array(12),(t=new DataView(n.buffer)).setUint32(0,i),l(t,4,r),n}((t=e.getTime(),r=Math.floor(t/1e3),i=1e6*(t-1e3*r),n=Math.floor(i/1e9),{sec:r+n,nsec:i-1e9*n})):null},decode:function(e){var t=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var r=t.getUint32(0);return{sec:4294967296*(3&r)+t.getUint32(4),nsec:r>>>2};case 12:return{sec:f(t,4),nsec:t.getUint32(0)};default:throw new c("Unrecognized data size for timestamp (expected 4, 8, or 12): "+e.length)}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}},p=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(_)}return e.prototype.register=function(e){var t=e.type,r=e.encode,i=e.decode;if(t>=0)this.encoders[t]=r,this.decoders[t]=i;else{var n=1+t;this.builtInEncoders[n]=r,this.builtInDecoders[n]=i}},e.prototype.tryToEncode=function(e,t){for(var r=0;r<this.builtInEncoders.length;r++){if(null!=(i=this.builtInEncoders[r]))if(null!=(n=i(e,t)))return new s(-1-r,n)}for(r=0;r<this.encoders.length;r++){var i,n;if(null!=(i=this.encoders[r]))if(null!=(n=i(e,t)))return new s(r,n)}return e instanceof s?e:null},e.prototype.decode=function(e,t,r){var i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,r):new s(t,e)},e.defaultCodec=new e,e}(),y=("undefined"==typeof process||"never"!==process.env.TEXT_ENCODING)&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function w(e){for(var t=e.length,r=0,i=0;i<t;){var n=e.charCodeAt(i++);if(0!=(4294967168&n))if(0==(4294965248&n))r+=2;else{if(n>=55296&&n<=56319&&i<t){var o=e.charCodeAt(i);56320==(64512&o)&&(++i,n=((1023&n)<<10)+(1023&o)+65536)}r+=0==(4294901760&n)?3:4}else r++}return r}var g=y?new TextEncoder:void 0,m=y?"undefined"!=typeof process&&"force"!==process.env.TEXT_ENCODING?200:0:h;var v=(null==g?void 0:g.encodeInto)?function(e,t,r){g.encodeInto(e,t.subarray(r))}:function(e,t,r){t.set(g.encode(e),r)},b=4096;function U(e,t,r){for(var i=t,n=i+r,o=[],s="";i<n;){var a=e[i++];if(0==(128&a))o.push(a);else if(192==(224&a)){var c=63&e[i++];o.push((31&a)<<6|c)}else if(224==(240&a)){c=63&e[i++];var h=63&e[i++];o.push((31&a)<<12|c<<6|h)}else if(240==(248&a)){var l=(7&a)<<18|(c=63&e[i++])<<12|(h=63&e[i++])<<6|63&e[i++];l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l)}else o.push(a);o.length>=b&&(s+=String.fromCharCode.apply(String,o),o.length=0)}return o.length>0&&(s+=String.fromCharCode.apply(String,o)),s}var x=y?new TextDecoder:null,j=y?"undefined"!=typeof process&&"force"!==process.env.TEXT_DECODER?200:0:h;function k(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}var A=16,S=16,O=function(){function e(e,t){void 0===e&&(e=A),void 0===t&&(t=S),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var r=0;r<this.maxKeyLength;r++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,r){e:for(var i=0,n=this.caches[r-1];i<n.length;i++){for(var o=n[i],s=o.bytes,a=0;a<r;a++)if(s[a]!==e[t+a])continue e;return o.str}return null},e.prototype.store=function(e,t){var r=this.caches[e.length-1],i={bytes:e,str:t};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=i:r.push(i)},e.prototype.decode=function(e,t,r){var i=this.find(e,t,r);if(null!=i)return this.hit++,i;this.miss++;var n=U(e,t,r),o=Uint8Array.prototype.slice.call(e,t,t+r);return this.store(o,n),n},e}(),E=function(e,t,r,i){return new(r||(r=Promise))((function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((i=i.apply(e,t||[])).next())}))},I=function(e,t){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(n=2&o[0]?i.return:o[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){s.label=o[1];break}if(6===o[0]&&s.label<n[1]){s.label=n[1],n=o;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(o);break}n[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},B=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(r){t[r]=e[r]&&function(t){return new Promise((function(i,n){(function(e,t,r,i){Promise.resolve(i).then((function(t){e({value:t,done:r})}),t)})(i,n,(t=e[r](t)).done,t.value)}))}}},T=function(e){return this instanceof T?(this.v=e,this):new T(e)},W=function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,n=r.apply(e,t||[]),o=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(e){n[e]&&(i[e]=function(t){return new Promise((function(r,i){o.push([e,t,r,i])>1||a(e,t)}))})}function a(e,t){try{(r=n[e](t)).value instanceof T?Promise.resolve(r.value.v).then(c,h):l(o[0][2],r)}catch(e){l(o[0][3],e)}var r}function c(e){a("next",e)}function h(e){a("throw",e)}function l(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}},L=-1,P=new DataView(new ArrayBuffer(0)),M=new Uint8Array(P.buffer),D=function(){try{P.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),F=new D("Insufficient data"),$=new O,C=function(){function e(e,t,r,i,n,o,s,a){void 0===e&&(e=p.defaultCodec),void 0===t&&(t=void 0),void 0===r&&(r=h),void 0===i&&(i=h),void 0===n&&(n=h),void 0===o&&(o=h),void 0===s&&(s=h),void 0===a&&(a=$),this.extensionCodec=e,this.context=t,this.maxStrLength=r,this.maxBinLength=i,this.maxArrayLength=n,this.maxMapLength=o,this.maxExtLength=s,this.keyDecoder=a,this.totalPos=0,this.pos=0,this.view=P,this.bytes=M,this.headByte=L,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=L,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=k(e),this.view=function(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=k(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(this.headByte!==L||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),r=k(e),i=new Uint8Array(t.length+r.length);i.set(t),i.set(r,t.length),this.setBuffer(i)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,r=this.pos;return new RangeError("Extra "+(t.byteLength-r)+" of "+t.byteLength+" byte(s) found at buffer["+e+"]")},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return I(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,r,i,o;return E(this,void 0,void 0,(function(){var s,a,c,h,l,f,u,d;return I(this,(function(_){switch(_.label){case 0:s=!1,_.label=1;case 1:_.trys.push([1,6,7,12]),t=B(e),_.label=2;case 2:return[4,t.next()];case 3:if((r=_.sent()).done)return[3,5];if(c=r.value,s)throw this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{a=this.doDecodeSync(),s=!0}catch(e){if(!(e instanceof D))throw e}this.totalPos+=this.pos,_.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return h=_.sent(),i={error:h},[3,12];case 7:return _.trys.push([7,,10,11]),r&&!r.done&&(o=t.return)?[4,o.call(t)]:[3,9];case 8:_.sent(),_.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(s){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,a]}throw f=(l=this).headByte,u=l.pos,d=l.totalPos,new RangeError("Insufficient data in parsing "+n(f)+" at "+d+" ("+u+" in the current buffer)")}}))}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return W(this,arguments,(function(){var r,i,n,o,s,a,c,h,l;return I(this,(function(f){switch(f.label){case 0:r=t,i=-1,f.label=1;case 1:f.trys.push([1,13,14,19]),n=B(e),f.label=2;case 2:return[4,T(n.next())];case 3:if((o=f.sent()).done)return[3,12];if(s=o.value,t&&0===i)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s),r&&(i=this.readArraySize(),r=!1,this.complete()),f.label=4;case 4:f.trys.push([4,9,,10]),f.label=5;case 5:return[4,T(this.doDecodeSync())];case 6:return[4,f.sent()];case 7:return f.sent(),0==--i?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((a=f.sent())instanceof D))throw a;return[3,10];case 10:this.totalPos+=this.pos,f.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return c=f.sent(),h={error:c},[3,19];case 14:return f.trys.push([14,,17,18]),o&&!o.done&&(l=n.return)?[4,T(l.call(n))]:[3,16];case 15:f.sent(),f.label=16;case 16:return[3,18];case 17:if(h)throw h.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!==(i=e-128)){this.pushMapState(i),this.complete();continue e}t={}}else if(e<160){if(0!==(i=e-144)){this.pushArrayState(i),this.complete();continue e}t=[]}else{var r=e-160;t=this.decodeUtf8String(r,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e){r=this.lookU8();t=this.decodeUtf8String(r,1)}else if(218===e){r=this.lookU16();t=this.decodeUtf8String(r,2)}else if(219===e){r=this.lookU32();t=this.decodeUtf8String(r,4)}else if(220===e){if(0!==(i=this.readU16())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(221===e){if(0!==(i=this.readU32())){this.pushArrayState(i),this.complete();continue e}t=[]}else if(222===e){if(0!==(i=this.readU16())){this.pushMapState(i),this.complete();continue e}t={}}else if(223===e){if(0!==(i=this.readU32())){this.pushMapState(i),this.complete();continue e}t={}}else if(196===e){var i=this.lookU8();t=this.decodeBinary(i,1)}else if(197===e){i=this.lookU16();t=this.decodeBinary(i,2)}else if(198===e){i=this.lookU32();t=this.decodeBinary(i,4)}else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e){i=this.lookU8();t=this.decodeExtension(i,1)}else if(200===e){i=this.lookU16();t=this.decodeExtension(i,2)}else{if(201!==e)throw new c("Unrecognized type byte: "+n(e));i=this.lookU32();t=this.decodeExtension(i,4)}this.complete();for(var o=this.stack;o.length>0;){var s=o[o.length-1];if(0===s.type){if(s.array[s.position]=t,s.position++,s.position!==s.size)continue e;o.pop(),t=s.array}else{if(1===s.type){if(a=void 0,"string"!==(a=typeof t)&&"number"!==a)throw new c("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new c("The key __proto__ is not allowed");s.key=t,s.type=2;continue e}if(s.map[s.key]=t,s.readCount++,s.readCount!==s.size){s.key=null,s.type=1;continue e}o.pop(),t=s.map}}return t}var a},e.prototype.readHeadByte=function(){return this.headByte===L&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=L},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new c("Unrecognized array type byte: "+n(e))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new c("Max length exceeded: map length ("+e+") > maxMapLengthLength ("+this.maxMapLength+")");this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new c("Max length exceeded: array length ("+e+") > maxArrayLength ("+this.maxArrayLength+")");this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var r;if(e>this.maxStrLength)throw new c("Max length exceeded: UTF-8 byte length ("+e+") > maxStrLength ("+this.maxStrLength+")");if(this.bytes.byteLength<this.pos+t+e)throw F;var i,n=this.pos+t;return i=this.stateIsMapKey()&&(null===(r=this.keyDecoder)||void 0===r?void 0:r.canBeCached(e))?this.keyDecoder.decode(this.bytes,n,e):e>j?function(e,t,r){var i=e.subarray(t,t+r);return x.decode(i)}(this.bytes,n,e):U(this.bytes,n,e),this.pos+=t+e,i},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new c("Max length exceeded: bin length ("+e+") > maxBinLength ("+this.maxBinLength+")");if(!this.hasRemaining(e+t))throw F;var r=this.pos+t,i=this.bytes.subarray(r,r+e);return this.pos+=t+e,i},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new c("Max length exceeded: ext length ("+e+") > maxExtLength ("+this.maxExtLength+")");var r=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,r,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e,t,r=(e=this.view,t=this.pos,4294967296*e.getUint32(t)+e.getUint32(t+4));return this.pos+=8,r},e.prototype.readI64=function(){var e=f(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}(),z={};function R(e,t){return void 0===t&&(t=z),new C(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}var q=100,N=2048,V=function(){function e(e,t,r,i,n,o,s,a){void 0===e&&(e=p.defaultCodec),void 0===t&&(t=void 0),void 0===r&&(r=q),void 0===i&&(i=N),void 0===n&&(n=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===a&&(a=!1),this.extensionCodec=e,this.context=t,this.maxDepth=r,this.initialBufferSize=i,this.sortKeys=n,this.forceFloat32=o,this.ignoreUndefined=s,this.forceIntegerToFloat=a,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.getUint8Array=function(){return this.bytes.subarray(0,this.pos)},e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.getUint8Array()},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth "+t);null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),r=new Uint8Array(t),i=new DataView(t);r.set(this.bytes),this.view=i,this.bytes=r},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: "+e+" bytes in UTF-8");this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>m){var t=w(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),v(e,this.bytes,this.pos),this.pos+=t}else{t=w(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),function(e,t,r){for(var i=e.length,n=r,o=0;o<i;){var s=e.charCodeAt(o++);if(0!=(4294967168&s)){if(0==(4294965248&s))t[n++]=s>>6&31|192;else{if(s>=55296&&s<=56319&&o<i){var a=e.charCodeAt(o);56320==(64512&a)&&(++o,s=((1023&s)<<10)+(1023&a)+65536)}0==(4294901760&s)?(t[n++]=s>>12&15|224,t[n++]=s>>6&63|128):(t[n++]=s>>18&7|240,t[n++]=s>>12&63|128,t[n++]=s>>6&63|128)}t[n++]=63&s|128}else t[n++]=s}}(e,this.bytes,this.pos),this.pos+=t}},e.prototype.encodeObject=function(e,t){var r=this.extensionCodec.tryToEncode(e,this.context);if(null!=r)this.encodeExtension(r);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: "+Object.prototype.toString.apply(e));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: "+t);this.writeU8(198),this.writeU32(t)}var r=k(e);this.writeU8a(r)},e.prototype.encodeArray=function(e,t){var r=e.length;if(r<16)this.writeU8(144+r);else if(r<65536)this.writeU8(220),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large array: "+r);this.writeU8(221),this.writeU32(r)}for(var i=0,n=e;i<n.length;i++){var o=n[i];this.doEncode(o,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var r=0,i=0,n=t;i<n.length;i++){void 0!==e[n[i]]&&r++}return r},e.prototype.encodeMap=function(e,t){var r=Object.keys(e);this.sortKeys&&r.sort();var i=this.ignoreUndefined?this.countWithoutUndefined(e,r):r.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else{if(!(i<4294967296))throw new Error("Too large map object: "+i);this.writeU8(223),this.writeU32(i)}for(var n=0,o=r;n<o.length;n++){var s=o[n],a=e[s];this.ignoreUndefined&&void 0===a||(this.encodeString(s),this.doEncode(a,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: "+t);this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),function(e,t,r){var i=r/4294967296,n=r;e.setUint32(t,i),e.setUint32(t+4,n)}(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),l(this.view,this.pos,e),this.pos+=8},e}(),K={};function H(e,t){return void 0===t&&(t=K),new V(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encode(e)}r.d(t,"API_VERSION",(function(){return J})),r.d(t,"RPC",(function(){return ee}));const J="0.2.3",G=512e3,X=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function Q(e,t){const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}function Y(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?Y(e,t.split(".")):0===t.length?e:Y(e[t[0]],t.slice(1))}class Z{constructor(e,t,r,i){this._timeout=e,this._callback=t,this._args=r,this._label=i||"timer",this._task=null}start(){this._task=setTimeout(()=>{this._callback.apply(this,this._args)},1e3*this._timeout)}clear(){this._task&&(clearTimeout(this._task),this._task=null)}reset(){this.clear(),this.start()}}class ee extends i.a{constructor(e,{client_id:t=null,root_target_id:r=null,default_context:n=null,name:o=null,codecs:s=null,method_timeout:a=null,max_message_buffer_size:c=0,debug:h=!1}){super(h),this._codecs=s||{},Object(i.b)(t&&"string"==typeof t),Object(i.b)(t,"client_id is required"),this._client_id=t,this._name=o,this._user_info=null,this._workspace=null,this.root_target_id=r,this.default_context=n||{},this._method_annotations=new WeakMap,this._remote_root_service=null,this._max_message_buffer_size=c,this._chunk_store={},this._method_timeout=a||20,this._services={},this._object_store={services:this._services},e?(this.add_service({id:"built-in",type:"built-in",name:"RPC built-in services",config:{require_context:!0,visibility:"public"},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),register_service:this.register_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),Object(i.b)(e.emit_message&&e.on_message),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e,this._get_user_info()):this._emit_message=function(){console.log("No connection to emit message")}}async _get_user_info(){if(this.root_target_id)try{await this.get_remote_root_service(5),Object(i.b)(this._remote_root_service),this._user_info=await this._remote_root_service.get_user_info(),this._user_info.reconnection_token&&this._connection.set_reconnection_token&&(this._connection.set_reconnection_token(this._user_info.reconnection_token),console.info("Set reconnection token: ",this._user_info.reconnection_token))}catch(e){console.warn("Failed to fetch user info from ",this.root_target_id,e)}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return Object(i.b)("ping"==e),"pong"}async ping(e,t){let r=this._generate_remote_method({_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0});Object(i.b)("pong"==await r("ping",t))}_create_message(e,t,r,i){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!r&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,r,n){if(r){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const o=this._object_store.message_cache;if(!o[e])throw new Error(`Message with key ${e} does not exists.`);Object(i.b)(t instanceof X),o[e].push(t)}_remove_message(e,t){const r=this._object_store.message_cache;if(!r[e])throw new Error(`Message with key ${e} does not exists.`);delete r[e]}_process_message(e,t,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const n=this._object_store.message_cache;if(Object(i.b)(!!r,"Context is required"),!n[e])throw new Error(`Message with key ${e} does not exists.`);var o,s,a,c;n[e]=(o=n[e],s=o.map((function(e){return e.byteLength})),a=s.reduce((function(e,t){return e+t}),0),c=new Uint8Array(a),s.reduce((function(e,t,r){return c.set(new Uint8Array(o[r]),e),e+t}),0),c.buffer),console.debug(`Processing message ${e} (size=${n[e].length})`);let h=R(n[e]);const{done:l,value:f}=h.next(),u=f;if(Object.assign(u,{from:r.from,to:r.to,user:r.user}),u.ctx=JSON.parse(JSON.stringify(u)),Object.assign(u.ctx,this.default_context),!l){let e=h.next();Object.assign(u,e.value)}this._fire(u.type,u),delete n[e]}_on_message(e){Object(i.b)(e instanceof ArrayBuffer);let t=R(e);const{done:r,value:n}=t.next(),o=n;if(o.ctx=JSON.parse(JSON.stringify(o)),Object.assign(o.ctx,this.default_context),!r){let e=t.next();Object.assign(o,e.value)}this._fire(o.type,o)}reset(){this._event_handlers={},this._services={}}async disconnect(){this._fire("disconnect")}async get_remote_root_service(e){this.root_target_id&&!this._remote_root_service&&(this._remote_root_service=await this.get_remote_service(`${this.root_target_id}:default`,e))}get_all_local_services(){return this._services}get_local_service(e,t){Object(i.b)(e);const[r,n]=t.to.split("/");Object(i.b)(n===this._client_id);const o=this._services[e];if(!o)throw new Error("Service not found: "+e);if("public"==o.config.visibility)return o;if(t.from.startsWith(r+"/"))return o;throw new Error("Permission denied for service: "+e)}async get_remote_service(e,t){t=void 0===t?5:t,!e&&this.root_target_id?e=this.root_target_id:e.includes(":")||(e=this._client_id+":"+e);const r=e.split(":")[0];Object(i.b)(r);try{const i=this._generate_remote_method({_rtarget:r,_rmethod:"services.built-in.get_service",_rpromise:!0});return await function(e,t){let r;return Promise.race([e,new Promise((e,i)=>r=setTimeout(i,1e3*t))]).finally(()=>clearTimeout(r))}(i(e.split(":")[1]),t)}catch(t){throw console.error("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,r,i,n){if("function"==typeof e){let o=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(r)?r.includes(o):!!r,run_in_executor:i,method_id:"services."+t,visibility:n})}else if(e instanceof Array||e instanceof Object)for(let o of Object.keys(e)){let s=e[o];if("function"==typeof s&&s.__rpc_object__){if(this._client_id!==s.__rpc_object__._rtarget)throw new Error("Local method not found: "+s.__rpc_object__._rmethod);e instanceof Array&&(e=e.slice()),e[o]=Y(this._object_store,s.__rpc_object__._rmethod),s=e[o]}this._annotate_service_methods(s,t+"."+o,r,i,n)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={};for(let r of Object.getOwnPropertyNames(Object.getPrototypeOf(e)))"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e=t}e.id||(e.id="default"),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let r=!1,n=!1;e.config.require_context&&(r=e.config.require_context),e.config.run_in_executor&&(n=!0);const o=e.config.visibility||"protected";if(Object(i.b)(["protected","public"].includes(o)),this._annotate_service_methods(e,e.id,r,n,o),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}async register_service(e,t,r,n){if(void 0===r&&(r=!0),n){const[e,t]=n.to.split("/");Object(i.b)(t===this._client_id),Object(i.b)(e===n.from.split("/")[0],"Services can only be registered from the same workspace")}const o=this.add_service(e,t);return r&&(this._fire("service-updated",{service_id:o.id,api:o,type:"add"}),await this._notify_service_update()),{id:`${this._client_id}:${o.id}`,type:o.type,name:o.name,config:o.config}}async unregister_service(e,t){if(e instanceof Object&&(e=e.id),!this._services[e])throw new Error(`Service not found: ${e}`);const r=this._services[e];delete this._services[e],this._fire("service-updated",{service_id:e,api:r,type:"remove"}),await this._notify_service_update()}_ndarray(e,t,r){const n=Object(i.f)(e);if(r&&r!==n)throw"dtype doesn't match the type of the array: "+n+" != "+r;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:n}}_encode_callback(e,t,r,i,n,o){let s=`${r}.${e}`,a={_rtype:"method",_rtarget:o?`${o}/${this._client_id}`:this._client_id,_rmethod:s,_rpromise:!1};const c=this;return[a,function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error("Error in callback:",s,e)}finally{i&&c._object_store[r]&&(console.log("Deleting session",r,"from",c._client_id),delete c._object_store[r]),n&&n.clear()}}]}async _encode_promise(e,t,r,n,o,s){let a=this._get_session_store(r,!0);Object(i.b)(a,`Failed to create session store ${r} due to invalid parent`);let c={};return o&&t&&this._method_timeout?(c.heartbeat=await this._encode(o.reset.bind(o),r,s),c.interval=this._method_timeout/2,a.timer=o):o=null,[c.resolve,a.resolve]=this._encode_callback("resolve",e,r,n,o,s),[c.reject,a.reject]=this._encode_callback("reject",t,r,n,o,s),c}async _send_chunks(e,t,r){let n=await this.get_remote_service(`${t}:built-in`);Object(i.b)(n.message_cache,"Remote client does not support message caching for long message.");let o=n.message_cache,s=r||Object(i.e)();await o.create(s,!!r);let a=e.length,c=Math.ceil(a/G);for(let t=0;t<c;t++){let i=t*G;await o.append(s,e.slice(i,i+G),!!r),console.log(`Sending chunk ${t+1}/${c} (${a} bytes)`)}console.log(`All chunks sent (${c})`),await o.process(s,!!r)}_generate_remote_method(e,t,r,n,o){let s=e._rtarget;n&&!s.includes("/")&&(s=n+"/"+s);let a=e._rmethod,c=e._rpromise;const h=this;function l(){return new Promise(async(e,n)=>{let l=Object(i.e)();r&&(l=r+"."+l);let f=h._get_session_store(l,!0);Object(i.b)(f,`Failed to get session store ${l}`),f.target_id=s;const u=await h._encode(Array.prototype.slice.call(arguments),l,o),d=u.length,_=d>0&&"object"==typeof u[d-1]&&null!==u[d-1]&&u[d-1]._rkwargs;_&&delete u[d-1]._rkwargs;let p={type:"method",from:h._client_id,to:s,method:a},y={};u&&(y.args=u),_&&(y.with_kwargs=_),console.log(`Calling remote method ${s}:${a}, session: ${l}`),t&&(p.parent=t);let w=null;if(c){p.session=l;let t=`${s}:${a}`;w=new Z(h._method_timeout,n,[`Method call time out: ${t}`],t),y.promise=await h._encode_promise(e,n,l,!0,w,o)}let g=H(p);if(y){const e=H(y);g=new Uint8Array([...g,...e])}g.length<=G+1024?h._emit_message(g).then((function(){w&&(console.log("Start watchdog timer."),w.start())})):h._send_chunks(g,s,t).then((function(){w&&(console.log("Start watchdog timer."),w.start())}))})}return l.__rpc_object__=e,l}async _notify_service_update(){if(this.root_target_id)try{await this.get_remote_root_service(5),Object(i.b)(this._remote_root_service);const e=await this._remote_root_service.update_client_info(this.get_client_info());this._user_info=e.user_info,this._workspace=e.workspace}catch(e){console.warn("Failed to notify service update to",this.root_target_id,e)}}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push({id:`${this._client_id}:${t.id}`,type:t.type,name:t.name,config:t.config});return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{Object(i.b)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,o=e.from.split("/")[0],s=e.to.split("/")[0],a=e.parent;let c,h,l,f;if(e.promise){const i=await this._decode(e.promise,e.session,a,o,s);if(c=i.resolve,h=i.reject,i.heartbeat&&i.interval){async function r(){try{console.log("Reset heartbeat timer: "+e.method),await i.heartbeat()}catch(e){console.error(e)}}t=setInterval(r,1e3*i.interval)}}try{l=Y(this._object_store,e.method)}catch(e){throw console.error("Failed to find method",n,e),new Error(`Method not found: ${n}`)}if(Object(i.b)(l&&"function"==typeof l,"Invalid method: "+n),this._method_annotations.has(l)){if("protected"===this._method_annotations.get(l).visibility&&s!==o)throw new Error("Permission denied for protected method "+n+", workspace mismatch: "+s+" != "+o)}else{let t=this._object_store[e.method.split(".")[0]].target_id;if(s===o&&t&&-1===t.indexOf("/")&&(t=s+"/"+t),t!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from)}if(a&&Object(i.b)(null!==this._get_session_store(a,!0),"Parent session was closed: "+a),f=e.args?await this._decode(e.args,e.session,null,o,null):[],this._method_annotations.has(l)&&this._method_annotations.get(l).require_context&&f.push(e.ctx),console.log("Executing method: "+n),e.promise){const e=l.apply(null,f);e instanceof Promise?e.then(e=>{c(e),clearInterval(t)}).catch(e=>{h(e),clearInterval(t)}):(c(e),clearInterval(t))}else l.apply(null,f),clearInterval(t)}catch(e){console.error("Error during calling method: ",e),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){let r=this._object_store;const i=e.split(".");if(t){const e=i.length-1;for(let t of i.slice(0,e)){if(!r[t])return null;r=r[t]}return r[i[e]]||(r[i[e]]={}),r[i[e]]}for(let e of i){if(!r[e])return null;r=r[e]}return r}async _encode(e,t,r){const n=typeof e;if("number"===n||"string"===n||"boolean"===n||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__)return e.__rpc_object__;let o;if(e.constructor instanceof Object&&e._rtype){const i=e._rtype;return delete e._rtype,o=await this._encode(e,t,r),o._rtype=i,o}if("function"==typeof e){if(this._method_annotations.has(e)){let t=this._method_annotations.get(e);o={_rtype:"method",_rtarget:this._client_id,_rmethod:t.method_id,_rpromise:!0}}else{let r;Object(i.b)("string"==typeof t),r=e.__name__?`${Object(i.e)()}-${e.__name__}`:Object(i.e)(),o={_rtype:"method",_rtarget:this._client_id,_rmethod:`${t}.${r}`,_rpromise:!0};let n=this._get_session_store(t,!0);Object(i.b)(null!==n,`Failed to create session store ${t} due to invalid parent`),n[r]=e}return o}const s=Array.isArray(e);for(let i of Object.keys(this._codecs)){const n=this._codecs[i];if(n.encoder&&e instanceof n.type){let i=await Promise.resolve(n.encoder(e));if(i&&!i._rtype&&(i._rtype=n.name),"object"==typeof i){const e=i._rtype;delete i._rtype,i=await this._encode(i,t,r),i._rtype=e}return o=i,o}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const t=e.dataSync();o={_rtype:"ndarray",_rvalue:new Uint8Array(t.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){const t=Object(i.f)(e.selection.data);o={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:t}}else if(e instanceof Error)console.error(e),o={_rtype:"error",_rvalue:e.toString()};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)o=e;else if(e instanceof Blob){let i=0;async function a(t){let r;r=t?e.slice(i,i+t):e.slice(i);const n=new Uint8Array(await r.arrayBuffer());return i+=n.byteLength,n}function c(e){i=e}o={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(a,t,r),seek:await this._encode(c,t,r)}}else if(e instanceof X){const t=Object(i.f)(e);o={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:t}}else if(e instanceof DataView)o={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)o={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,r)};else if(e instanceof Map)o={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,r)};else{if(!(e.constructor instanceof Object||Array.isArray(e)))throw`imjoy-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{o=s?[]:{};const i=Object.keys(e);for(let n of i)o[n]=await this._encode(e[n],t,r)}}if(!o)throw new Error("Failed to encode object");return o}async decode(e){return await this._decode(e)}async _decode(e,t,r,n,o){if(!e)return e;let s;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const i=e._rtype;delete e._rtype,(e=await this._decode(e,t,r,n,o))._rtype=i,s=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)s=this._generate_remote_method(e,t,r,n,o);else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(Q)),s=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(Q));const t=i.c[e._rdtype];s=tf.tensor(new t(e._rvalue),e._rshape,e._rdtype)}else s=e;else if("error"===e._rtype)s=new Error(e._rvalue);else if("typedarray"===e._rtype){const t=i.c[e._rdtype];if(!t)throw new Error("unsupported dtype: "+e._rdtype);s=new t(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)s=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const i=await this._generate_remote_method(e.read,t,r,n,o),a=await i();s=new Blob([a],{type:e.type,name:e.name})}else{s={};for(let i of Object.keys(e))i.startsWith("_")||(s[i]=await this._decode(e[i],t,r,n,o))}s.__rpc_object__=e}else if("orderedmap"===e._rtype)s=new Map(await this._decode(e._rvalue,t,r,n,o));else if("set"===e._rtype)s=new Set(await this._decode(e._rvalue,t,r,n,o));else{const i=e._rtype;delete e._rtype,s=await this._decode(e,t,r,n,o),s._rtype=i}else if(e.constructor===Object||Array.isArray(e)){const i=Array.isArray(e);s=i?[]:{};for(let a of Object.keys(e))if(i||e.hasOwnProperty(a)){const i=e[a];s[a]=await this._decode(i,t,r,n,o)}}else s=e;if(void 0===s)throw new Error("Failed to decode object");return s}}},function(e){e.exports=JSON.parse('{"a":"0.4.4"}')},,function(e,t,r){"use strict";r.r(t),r.d(t,"connectToServer",(function(){return a}));var i=r(1);r.d(t,"RPC",(function(){return i.RPC})),r.d(t,"API_VERSION",(function(){return i.API_VERSION}));var n=r(0);r.d(t,"loadRequirements",(function(){return n.d}));var o=r(2);r.d(t,"VERSION",(function(){return o.a}));class s{constructor(e,t,r,i){Object(n.b)(e&&t,"server_url and client_id are required"),e=e+"?client_id="+t,r&&(e+="&workspace="+r),i&&(e+="&token="+i),this._websocket=null,this._handle_message=null,this._reconnection_token=null,this._server_url=e}set_reconnection_token(e){this._reconnection_token=e}on_message(e){Object(n.b)(e,"handler is required"),this._handle_message=e}async open(){const e=this._reconnection_token?`${this._server_url}&reconnection_token=${this._reconnection_token}`:this._server_url;console.info("Receating a new connection to ",e.split("?")[0]),this._websocket=new WebSocket(e),this._websocket.binaryType="arraybuffer",this._websocket.onmessage=e=>{const t=e.data;this._handle_message(t)};const t=this;return this._websocket.onclose=function(){console.log("websocket closed"),t._websocket=null},await new Promise(e=>{this._websocket.addEventListener("open",e)})}async emit_message(e){Object(n.b)(this._handle_message,"No handler for message"),this._websocket||await this.open();try{e.buffer&&(e=e.buffer),this._websocket.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){const t=this._websocket;this._websocket=null,t&&t.close(1e3,e),console.info(`Websocket connection disconnected (${e})`)}}async function a(e){let t=e.client_id;t||(t=Object(n.e)());let r=new s(e.server_url,t,e.workspace,e.token);await r.open();const o=new i.RPC(r,{client_id:t,root_target_id:"workspace-manager",default_context:{connection_type:"websocket"},name:e.name,method_timeout:e.method_timeout}),a=await o.get_remote_service("workspace-manager:default");return a.rpc=o,a.export=function(t){return t.id="default",t.name=e.name||"default",o.register_service(t,!0)},a.getPlugin=async function(e){return await a.get_service(e+":default")},a.listPlugins=a.listServices,a.disconnect=async function(){await o.disconnect(),await r.disconnect()},a.registerCodec=o.register_codec.bind(o),a}}])}));
//# sourceMappingURL=imjoy-websocket-client.min.js.map